{"version":3,"sources":["../../../src/home/controller/explorer.js"],"names":["indexAction","assign","path","process","cwd","replace","display","openAction","self","socket","http","broadcast","launcherAction","exec","cmd","data","think","isEmpty","console","log","stbui","stdout","setEncoding","on","emit","stderr","closeAction","mkfileAction","get","decodeURIComponent","isFile","writeFileSync","json","mkdirAction","isDir","mkdir","pathrnameAction","post","rname","success","pathdeleteAction","delFile","JSON","parse","file","type","rmdir","then","unlinkSync","filedownloadAction","name","split","pop","download","historybackAction","pathinfoAction","pathcopyAction","zipDdownloadAction","zipAction","searchAction","treelistAction","children","dir","files","readdirSync","forEach","filename","fullname","join","stats","statSync","isDirectory","push","atime","ctime","mtime","mode","is_readable","is_writeable","pathlistAction","getAllFiles","folderlist","fielList","k","v","ext","size_friendly","size","map","stat","getTime","filter","start","indexOf","end","length","substring","getFileContent","buffer","readFileSync"],"mappings":"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","file":"explorer.js","sourcesContent":["'use strict';\r\n\r\nimport Base from './base.js';\r\nimport fs from 'fs';\r\nimport child_process from 'child_process';\r\nimport path from 'path';\r\n\r\nexport default class extends Base {\r\n\r\n    indexAction() {\r\n        this.assign({\r\n            path:process.cwd().replace(/\\\\/g,'/')+'/'\r\n        });\r\n\r\n        return this.display();\r\n    }\r\n\r\n    openAction(self) {\r\n        const socket = self.http.socket;\r\n        this.broadcast(\"new message\", \"connected\");\r\n    }\r\n\r\n    launcherAction(self) {\r\n        const exec = child_process.exec;\r\n        const {cmd} = self.http.data;\r\n\r\n        if(think.isEmpty(cmd)) {\r\n            return;\r\n        }\r\n        console.log(cmd);\r\n\r\n        const stbui = exec(cmd);\r\n        stbui.stdout.setEncoding('UTF-8');\r\n        stbui.stdout.on('data', (data) => {\r\n            this.emit('launcher', data);\r\n        });\r\n\r\n        stbui.stderr.setEncoding('UTF-8');\r\n        stbui.stderr.on('data', (data) => {\r\n            this.emit('launcher', data);\r\n        });\r\n\r\n        stbui.on('close', () => {\r\n            // this.emit('launcher', '');\r\n            // this.emit('launcher', 'bright: complete');\r\n        });\r\n\r\n    }\r\n\r\n    closeAction(self) {\r\n        this.broadcast(\"new message\", \"disconnected\");\r\n    }\r\n\r\n    // 新建文件\r\n    mkfileAction() {\r\n        let path = this.get('path');\r\n        path = decodeURIComponent(path);\r\n\r\n        if (!think.isFile(path)) {\r\n            fs.writeFileSync(path, '');\r\n        }\r\n\r\n        this.json({\"code\": true, \"use_time\": 0, \"data\": \"\\u65b0\\u5efa\\u6210\\u529f\\uff01\"});\r\n    }\r\n\r\n    // 新建目录\r\n    mkdirAction() {\r\n        let path = this.get('path');\r\n        path = decodeURIComponent(path);\r\n\r\n        if (!think.isDir(path)) {\r\n            think.mkdir(path);\r\n        }\r\n\r\n        this.json({\"code\": true, \"use_time\": 0, \"data\": \"\\u65b0\\u5efa\\u6210\\u529f\\uff01\"});\r\n    }\r\n\r\n    pathrnameAction() {\r\n        let path = this.post('path');\r\n        let rname = this.post('rname_to');\r\n\r\n        // 修改目录\r\n        // think.chmod(file);\r\n\r\n        this.success();\r\n    }\r\n\r\n\r\n    /*\r\n     * 删除目录或文件\r\n     */\r\n    pathdeleteAction() {\r\n        let delFile = this.post('list');\r\n        delFile = JSON.parse(delFile);\r\n\r\n        let file = delFile[0].path;\r\n        file = decodeURIComponent(file);\r\n\r\n        if (delFile[0].type == 'folder') {\r\n            think.rmdir(file).then(() => {\r\n                this.success({}, 'success');\r\n            });\r\n\r\n            // fs.rmdirSync(file);\r\n        } else if (delFile[0].type == 'file') {\r\n\r\n            fs.unlinkSync(file);\r\n        }\r\n\r\n        this.json({\"code\": true, \"use_time\": 0, \"data\": \"删除成功\"});\r\n    }\r\n\r\n    filedownloadAction() {\r\n        let file = this.get('path');\r\n        file = decodeURIComponent(file);\r\n\r\n        let name = file.split('/').pop();\r\n\r\n        this.download(file, name);\r\n\r\n        this.success({\r\n            name: name,\r\n            path: file\r\n        });\r\n    }\r\n\r\n    historybackAction() {\r\n        this.success();\r\n    }\r\n\r\n    pathinfoAction() {\r\n        this.success();\r\n    }\r\n\r\n    pathcopyAction() {\r\n        this.success();\r\n    }\r\n\r\n    zipDdownloadAction() {\r\n        this.success();\r\n    }\r\n\r\n    zipAction() {\r\n        this.success();\r\n    }\r\n\r\n    searchAction() {\r\n        this.success();\r\n    }\r\n\r\n    treelistAction() {\r\n        let children = [];\r\n        let dir = process.cwd();\r\n        let files = fs.readdirSync(dir);\r\n\r\n        files.forEach(function (filename) {\r\n            let fullname = path.join(dir, filename);\r\n            let stats = fs.statSync(fullname);\r\n\r\n            if (stats.isDirectory()) {\r\n\r\n                children.push({\r\n                    name: filename,\r\n                    type: 'folder',\r\n                    atime: +stats.atime,\r\n                    ctime: +stats.ctime,\r\n                    mtime: +stats.mtime,\r\n                    path: process.cwd() + '\\\\',\r\n                    mode: 'drwx rwx rwx (0777) ',\r\n                    is_readable: 1,\r\n                    is_writeable: 1\r\n                });\r\n\r\n            }\r\n\r\n            // process.stdout.write(filename + '\\t' +\r\n            //   stats.size + '\\t' +\r\n            //   stats.mtime + '\\n'\r\n            // );\r\n\r\n        });\r\n\r\n\r\n        let data = {\r\n            \"code\": true,\r\n            \"use_time\": 0,\r\n            \"data\": [{\r\n                \"name\": \"收藏夹\",\r\n                \"iconSkin\": \"fav\",\r\n                \"menuType\": \"menuTreeFavRoot\",\r\n                \"open\": true,\r\n                \"children\": []\r\n            }, {\r\n                \"name\": \"我的项目\",\r\n                \"children\": children,\r\n                \"menuType\": \"menuTreeRoot\",\r\n                \"iconSkin\": \"my\",\r\n                \"open\": true,\r\n                \"this_path\": process.cwd(),\r\n                \"isParent\": true\r\n            }, {\r\n                \"name\": \"公共目录\",\r\n                \"children\": [],\r\n                \"menuType\": \"menuTreeRoot\",\r\n                \"iconSkin\": \"lib\",\r\n                \"open\": true,\r\n                \"this_path\": \"*public*\",\r\n                // \"this_path\": think.ROOT_PATH,\r\n                \"isParent\": false\r\n            }\r\n            ]\r\n        };\r\n\r\n\r\n        this.json(data);\r\n    }\r\n\r\n    pathlistAction() {\r\n        let path = this.get('path');\r\n        path = decodeURIComponent(decodeURIComponent(decodeURIComponent(path)));\r\n\r\n        let files = this.getAllFiles(path);\r\n\r\n        let folderlist = [],\r\n            fielList = [];\r\n\r\n        files.forEach(function (k, v) {\r\n\r\n            let data = {};\r\n\r\n            data.name = k.name;\r\n            data.type = k.type;\r\n            data.atime = k.atime;\r\n            data.ctime = k.ctime;\r\n            data.mtime = k.mtime;\r\n            data.path = path;\r\n            data.mode = 'drwx rwx rwx (0777) ';\r\n            data.is_readable = 1;\r\n            data.is_writeable = 1;\r\n\r\n            if (k.type == 'folder') {\r\n                folderlist.push(data);\r\n            } else if (k.type == 'file') {\r\n                data.ext = k.ext;\r\n                data.size_friendly = \"\";\r\n                data.size = '0',\r\n                    fielList.push(data);\r\n            }\r\n\r\n        });\r\n\r\n        let data = {\r\n            \"code\": true,\r\n            \"use_time\": 0.015625,\r\n            \"data\": {\r\n                \"folderlist\": folderlist,\r\n                \"filelist\": fielList,\r\n                \"path_type\": \"writeable\",\r\n                \"history_status\": {\r\n                    \"back\": 1,\r\n                    \"next\": 0\r\n                }\r\n            }\r\n        };\r\n\r\n        this.json(data);\r\n    }\r\n\r\n    getAllFiles(dir) {\r\n\r\n        let files = fs.readdirSync(dir).map(function (file) {\r\n\r\n            let stat = fs.statSync(dir + file);\r\n            let type = null;\r\n\r\n            if (stat.isDirectory()) {\r\n                type = 'folder';\r\n            } else if (stat.isFile()) {\r\n                type = 'file';\r\n            }\r\n\r\n            return {\r\n                name: file,\r\n                type: type,\r\n                size: stat.size,\r\n                atime: stat.atime.getTime(),\r\n                mtime: stat.mtime.getTime(),\r\n                ctime: stat.ctime.getTime(),\r\n                mode: stat.mode\r\n            }\r\n        }).filter(function (file) {\r\n            let start = file.name.indexOf('.');\r\n            let end = file.length;\r\n            let ext = '';\r\n\r\n            if (start > 0) {\r\n                ext = file.name.substring(start + 1, end);\r\n            }\r\n\r\n            file.ext = ext;\r\n            return true;\r\n        });\r\n\r\n        return files;\r\n    }\r\n\r\n    getFileContent(file) {\r\n        let buffer = fs.readFileSync(file);\r\n\r\n        return buffer;\r\n    }\r\n}"]}